---
layout: post
title: 解决Dropbox大陆地区无法及时自动同步的问题
date: 2012-04-03 22:10:26.641000
tags: Dropbox, GFW
---

**本文内容已经更新，方法目前可用**，但需要配合hosts大法。请自行搜索dropbox hosts, 并将notify*.dropbox.com的ip改为本文提供服务的ip。一般是本机比较方便。

最近由于想要使用Dropbox的多人协作功能，就发现Dropbox不能自动同步其他机器上产生的文件变化，经过一番搜索，发现原来是GFW在作怪（GFW和GD的性质和用心我们心知肚明，就不在这里评价了）。月光博客发布了[解决Dropbox无法实时更新的问题](http://www.williamlong.info/archives/2585.html)分析了产生这个问题的原因并提出一个有效的解决方案。但是在使用时我发现，我找不到一个优良稳定的代理服务器，也没工夫去学习privoxy软件的配置和使用，而且我要将解决方案提供给我的合伙人，一个复杂的方案是不能接受的。经过一番研究，提出如下比较**简单**的办法：

分析
======

我发现Dropbox向notify8发出的请求很简单，回应也很简单，一共有两种：

	{"ret":"new"}
	和
	{"ret":"punt"}

分别表示云端有变化和无变化，然后客户端考虑去下载文件列表并同步。

经过一番痛苦的失败，我发现这个请求的其实是一个comet请求，服务器端并不马上回应，而是会挂起，如果有变化，则马上回应，如果一直没有变化，大约一分钟超时回应punt，然后客户端再连接服务器。在我分析Dropbox的过程中一直不解：为什么Dropbox的其他请求都是https，而只有这一个请求是http的。现在找到了答案：因为它是comet请求，长连接，而且连接频率非常高，如果使用https代价太大，而且影响效率。如果这个请求返回new，客户端就会使用https连接服务器端。

解决
======

由此提出一个完美的解决方案，不仅可以解决本机的问题，而且可以解决朋友的问题，只要让朋友修改hosts为我的ip地址：

* 修改hosts将notify8对应的ip地址改为本机
* 在本机建立一个http服务，代理notify8得到dropbox的返回值，再原封不动地返回给本机dropbox客户端

具体方法是使用tornado，进行一步http请求，这样只占用很少一部分系统资源。贴出代码。

代码
======
<script src="https://gist.github.com/ayang/3199360.js"></script>

**版权声明：** 原创作品，允许转载，转载请务必以超链接形式标明原始出处，否则将追究法律责任。 Tekzip.com